<!--
    Psion OPK Editor v3.0 - Architecture Overview
    =============================================
    This is the main entry point (Bootstrapper) for the application.
    
    Architecture:
    - Single Page Application (SPA) structure.
    - Loads CSS styles for theming and layout.
    - Loads JavaScript modules in a specific order:
      1. Core/Logic: Data models and utilities (Constants, BinaryFile, PackImage).
      2. UI/Editors: Base classes and specific file editors.
      3. UI/Managers: Helpers for options, themes, tooltips.
      4. UI/Components: Reusable widgets (Modal, MemoryMap, PackContents).
      5. Controller: The main orchestrator (opkedit.js).
    
    The application initialization is triggered by the controller (opkedit.js)
    once the DOM is fully loaded.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psion OPK Editor v03.00.14</title>

    <!-- Stylesheets with cache busting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        id="font-awesome-css">
    <link rel="stylesheet" href="styles/base.css?v=03.00.14">
    <link rel="stylesheet" href="styles/layout.css?v=03.00.14">
    <link rel="stylesheet" href="styles/components.css?v=03.00.14">
    <link rel="stylesheet" href="styles/editor.css?v=03.00.14">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="styles/psion.css?v=03.00.14">
    <link rel="stylesheet" href="styles/syntax.css?v=03.00.14">
</head>

<body>
    <div id="app">
        <!-- Toolbar -->
        <div id="toolbar">
            <!-- File Dropdown (Consolidated) -->
            <div class="dropdown">
                <button class="tool-btn dropbtn" id="btn-file-menu" title="File Menu">
                    <i class="fas fa-bars"></i> File <i class="fas fa-angle-down"
                        style="font-size: 0.8em; margin-left: 3px;"></i>
                </button>
                <div class="dropdown-content" id="file-dropdown"
                    style="min-width: 220px; left: 0; right: auto; max-height: 80vh; overflow-y: auto;">
                    <!-- New Items -->
                    <a href="#" id="menu-new-pack"><i class="fas fa-box" style="width: 20px;"></i> New Pack</a>
                    <a href="#" id="menu-new-proc"><i class="fas fa-file-code" style="width: 20px;"></i> New OPL
                        Procedure</a>
                    <a href="#" id="menu-new-notepad"><i class="fas fa-sticky-note" style="width: 20px;"></i> New
                        Notepad Entry</a>
                    <a href="#" id="menu-new-datafile"><i class="fas fa-database" style="width: 20px;"></i> New Data
                        File</a>

                    <div id="new-dynamic-separator" style="display:none;">
                        <hr style="margin: 5px 0; border: 0; border-top: 1px dashed var(--border-color); opacity: 0.5;">
                    </div>
                    <div id="new-dynamic-container"></div>

                    <hr style="margin: 5px 0; border: 0; border-top: 1px solid var(--border-color);">

                    <!-- Open Items -->
                    <a href="#" id="menu-open-pack"><i class="fas fa-folder-open" style="width: 20px;"></i> Open
                        Pack</a>
                    <a href="#" id="menu-import-item" class="disabled"><i class="fas fa-file-import"
                            style="width: 20px;"></i> Open Item (Import)</a>

                    <hr style="margin: 5px 0; border: 0; border-top: 1px solid var(--border-color);">

                    <!-- Save Items -->
                    <a href="#" id="menu-save-pack" class="disabled"><i class="fas fa-save" style="width: 20px;"></i>
                        Save Pack (.opk)</a>
                    <a href="#" id="menu-export-hex" class="disabled"><i class="fas fa-file-code"
                            style="width: 20px;"></i> Save Pack (.hex)</a>
                    <a href="#" id="menu-export-item" class="disabled"><i class="fas fa-file-export"
                            style="width: 20px;"></i> Save Item (Export)</a>
                </div>
            </div>

            <div class="tool-separator"></div>

            <button class="tool-btn" id="btn-delete-item" title="Delete Item">
                <i class="fas fa-trash-can"></i> Delete
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn" id="btn-apply" title="Apply Changes">
                <i class="fas fa-circle-check"></i> Apply
            </button>
            <button class="tool-btn" id="btn-discard" title="Discard Changes">
                <i class="fas fa-circle-arrow-left"></i> Discard
            </button>

            <!-- Spacer to push options/help right -->
            <div style="flex: 1;"></div>

            <button class="tool-btn" id="btn-options" title="Options">
                <i class="fas fa-sliders"></i> Options
            </button>

            <div class="dropdown">
                <button class="tool-btn dropbtn" id="btn-help" title="Help">
                    <i class="fas fa-question-circle"></i> Help <i class="fas fa-angle-down"
                        style="font-size: 0.8em; margin-left: 3px;"></i>
                </button>
                <div class="dropdown-content" id="help-dropdown">
                    <a href="#" id="menu-opl-ref"><i class="fas fa-book" style="width: 20px;"></i> OPL Command
                        Reference</a>
                    <a href="#" id="menu-opl-templates"><i class="fas fa-file-code" style="width: 20px;"></i> OPL
                        Templates</a>
                    <a href="#" id="menu-opl-library"><i class="fas fa-book-open" style="width: 20px;"></i> OPL
                        Library Routines</a>
                    <a href="key_template.html" target="_blank" id="menu-key-template"><i class="fas fa-keyboard"
                            style="width: 20px;"></i> Printable Key Template</a>
                    <a href="#" id="menu-about"><i class="fas fa-info-circle" style="width: 20px;"></i> About</a>
                </div>
            </div>
        </div>

        <!-- Icon Toolbar (New) -->
        <div id="icon-toolbar" class="icon-toolbar">
            <!-- Populated via script -->
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Sidebar -->
            <div id="sidebar">
                <div id="sidebar-header">Pack Contents</div>
                <div id="pack-list">
                    <!-- Items will be populated here -->
                </div>
                <div id="sidebar-resizer"></div>
            </div>

            <!-- Editor Area -->
            <div id="editor-area">
                <div id="editor-header">
                    <span id="current-file-name">No file selected</span>
                </div>
                <div id="editor-container">
                    <!-- Code Editor will be mounted here -->
                    <div id="code-editor-container" style="width: 100%; height: 100%; display: none;"></div>
                    <!-- Legacy Editor for forms/headers -->
                    <div id="legacy-editor" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <div class="status-item" id="status-message">Ready</div>
            <div class="status-item" id="status-checksum"></div>
        </div>

        <!-- Hidden File Inputs -->
        <input type="file" id="file-input-pack" accept=".opk,.hex,.ihx,.bin">
        <input type="file" id="file-input-item" multiple>
    </div>

    <!-- Scripts -->
    <!-- Logic Scripts -->
    <script src="src/core/Constants.js?v=03.00.14"></script>
    <script src="src/core/AppStore.js"></script>
    <script src="src/logic/binaryfile.js"></script>
    <script src="src/logic/checksums.js"></script>
    <script src="src/logic/intelhex.js"></script>
    <script src="src/logic/packimage.js?v=03.00.14"></script>
    <script src="src/logic/decompiler/constants.js?v=03.00.14"></script>
    <script src="src/logic/decompiler/system_constants.js"></script>
    <script src="src/logic/decompiler/stack.js"></script>
    <script src="src/logic/decompiler/disassembler.js"></script>
    <script src="src/logic/decompiler/instruction_handler.js?v=03.00.14"></script>
    <script src="src/logic/decompiler/source_generator.js?v=03.00.14"></script>
    <script src="src/logic/compiler/Compiler.js?v=03.00.14"></script>

    <script src="src/logic/decompiler/main.js?v=03.00.14"></script>
    <script src="src/ui/editors/BaseEditor.js?v=cb1"></script>
    <script src="src/ui/editors/HexEditor.js?v=cb1"></script>
    <script src="src/ui/editors/BlockFileEditor.js?v=cb1"></script>
    <script src="src/ui/editors/HeaderEditor.js?v=refactor_header_style_complete"></script>
    <script src="src/ui/editors/HeaderlessFileEditor.js?v=cb1"></script>
    <script src="src/ui/editors/DataFileEditor.js?v=cb1"></script>
    <script src="src/ui/editors/CommsSetupEditor.js?v=cb1"></script>
    <script src="src/ui/editors/ProcedureFileEditor.js?v=record_fix_be_6"></script>
    <script src="src/ui/utils/NotepadUtils.js?v=cb1"></script>
    <script src="src/ui/editors/LZNotepadFileEditor.js?v=cb7"></script>
    <script src="src/ui/editors/SpreadsheetFormulaDecoder.js?v=cb1"></script>
    <script src="src/ui/editors/SpreadsheetFileEditor.js?v=debug_parse_2"></script>
    <script src="src/ui/editors/PagerSetupFileEditor.js?v=cb1"></script>
    <script src="src/ui/editors/DiaryFileEditor.js?v=cb1"></script>

    <script src="src/ui/editors/RecordEditor.js?v=cb1"></script>
    <script src="src/ui/editors/MemoryMapEditor.js?v=cb1"></script>
    <script src="src/ui/managers/optionsmanager.js?v=03.00.14"></script>
    <script src="src/ui/managers/thememanager.js"></script>
    <script src="src/ui/managers/DialogManager.js?v=force_1"></script>
    <script src="src/ui/managers/tooltipmanager.js"></script>

    <!-- Controller -->
    <script src="src/ui/utils/EditorUtils.js?v=type_fix_2"></script>
    <script src="src/ui/components/syntaxhighlighter.js"></script>
    <script src="src/ui/components/codeeditor.js"></script>
    <script src="src/ui/components/modal.js"></script>
    <script src="src/ui/components/dragdroplist.js"></script>
    <script src="src/ui/components/MemoryMap.js?v=fix_canvas_crash"></script>
    <script src="src/ui/components/HexViewer.js"></script>
    <script src="src/ui/components/CodeVisualizer.js?v=03.00.14"></script>
    <script src="src/ui/components/PackContents.js?v=03.00.14"></script>
    <script src="src/ui/components/OPLCommandData.js"></script>
    <script src="src/ui/components/DecompilerLogWindow.js?v=03.00.14"></script>
    <script src="src/ui/components/VariableStorageWindow.js?v=03.00.14"></script>
    <script src="src/ui/components/SpreadsheetDebugWindow.js"></script>
    <script src="src/ui/components/OPLCommandReference.js?v=03.00.14"></script>
    <script src="src/ui/components/OPLCodeContent.js"></script>
    <script src="src/ui/components/OPLContentViewer.js"></script>

    <script src="src/ui/controllers/opkedit.js?v=03.00.14"></script>
    <script>
        // Controller will handle initialization
    </script>
</body>

</html>