(function (root,factory){if(typeof define==='function'&&define.amd){define([],factory);}else if(typeof module==='object'&&module.exports){module.exports=factory();}else{root.ProtocolUtils=factory();}}(typeof self!=='undefined'?self:this,function (){const ProtocolUtils={hex:function (str){return new Uint8Array(str.match(/.{1,2}/g).map(byte=>parseInt(byte,16)));},hexArr:function (data){return Array.from (data).map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' ');},createFrame:function (header,data,lengthOverride){let len=(lengthOverride!==undefined)?lengthOverride:data.length;let packet=[0x16,0x10,header,len];let crcLoad=[len];let stuffedData=[];for(let b of data){crcLoad.push(b);if(b===0x10)stuffedData.push(0x10,0x10);else stuffedData.push(b);}let crc=this.calculateCRC(crcLoad);return new Uint8Array([...packet,...stuffedData,0x10,0x03,crc&0xFF,(crc>>8)&0xFF]);},calculateCRC:function (buffer){let crc=0x0000;const poly=0xA001;for(let i=0;i<buffer.length;i++){crc^=buffer[i];for(let j=0;j<8;j++){if(crc&1)crc=(crc>>>1)^poly;else crc=crc>>>1;}}return crc;},validatePacketCRC:function (hexStr){let bytes=new Uint8Array(hexStr.match(/.{1,2}/g).map(byte=>parseInt(byte,16)));let crcGiven=(bytes[bytes.length-1]<<8)|bytes[bytes.length-2];let rawPayload=bytes.slice(3,bytes.length-4);let payload=[];for(let i=0;i<rawPayload.length;i++){payload.push(rawPayload[i]);if(rawPayload[i]===0x10&&i<rawPayload.length-1&&rawPayload[i+1]===0x10){i++;}}let crc=0x0000;const poly=0xA001;for(let i=0;i<payload.length;i++){crc^=payload[i];for(let j=0;j<8;j++){if(crc&1)crc=(crc>>>1)^poly;else crc=crc>>>1;}}if(crc!==crcGiven){console.log(`[CRC FAIL DEBUG]String:${hexStr}`);console.log(`[CRC FAIL DEBUG]Bytes:${bytes.length}Payload:${payload.length}`);}return {valid:(crc===crcGiven),given:crcGiven,calc:crc};},calculateSimpleSum:function (data){let sum=0;for(let b of data)sum+=b;return sum>>>0;},calculateCRC32:function (data){var table=new Uint32Array(256);for(var i=0;i<256;i++){var c=i;for(var j=0;j<8;j++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));}table[i]=c;}var crc=0xFFFFFFFF;for(var i=0;i<data.length;i++){crc=(crc>>>8)^table[(crc^data[i])&0xFF];}return (crc^0xFFFFFFFF)>>>0;}};return ProtocolUtils;}));