class ProtocolHandler{constructor(serial,logger,onComplete,onStatus,packType){this.serial=serial;this.logger=logger;this.onComplete=onComplete;this.onStatus=onStatus||(()=>{});this.packType=packType||'B';this.logger(`Protocol Initialized for Pack Type:${this.packType}`,'info');this.link=new LinkLayer(serial,logger);this.state='IDLE';this.subState=0;this.retryCount=0;this.receivedData=[];this.rxLog=[];this.timer=null;this.packetAcked=false;this.expectedBootSeq=0;this.gotHandoverPacket=false;this.FINAL_PKT_7="161002010710034052";this.FINAL_PKT_8="16100201080010035600";this.link.onFrame=(frame)=>this.handleFrame(frame);}getBootPairs(){if(typeof window.getBootPairs==='function'){return window.getBootPairs(this.packType);}if(window.BOOT_PAIRS){this.logger("[WARN]using global BOOT_PAIRS(Legacy)",'warn');return window.BOOT_PAIRS;}return [];}sleep(ms){return new Promise(r=>setTimeout(r,ms));}async simulateBaudWait(byteLen){let ms=byteLen*1.05;if(ms<20){const start=performance.now();while(performance.now()-start<ms);}else{await this.sleep(ms);}}async start(){const RUN_ID=`RUN-${Date.now().toString().slice(-4)}`;this.logger(`Starting Protocol(Linear Boot+FSM Dump)v131[FIXED](${RUN_ID})...`,'info');this.receivedData=[];this.state='BOOT_POLL';this.finished=false;this.logicalSize=0;this.physicalSize=0;let polled=false;let attempts=0;this.onStatus('Searching for Device...');while(!polled&&attempts<50){attempts++;if(attempts%10===0)this.logger(`Polling(Attempt ${attempts})...`,'info');this.state='BOOT_POLL';this.packetAcked=false;await this.serial.write(ProtocolUtils.hex('1610020110101003005c'));let wait=0;while(!this.packetAcked&&wait<10){await this.sleep(10);wait++;}if(this.packetAcked)polled=true;}if(!polled){this.logger("Timeout waiting for device(0x10 echo).",'error');return;}this.logger("Device Ready. Sending Boot Request...",'info');this.state='BOOT_REQ';this.onStatus('Downloading Boot Code...');let bootConfirmed=false;attempts=0;while(!bootConfirmed&&attempts<10){attempts++;this.packetAcked=false;await this.serial.write(ProtocolUtils.hex('161002010010030190'));let wait=0;while(!this.packetAcked&&wait<100){await this.sleep(10);wait++;}if(this.packetAcked)bootConfirmed=true;}if(!bootConfirmed){this.logger("Did not receive BOOT confirmation. Aborting.",'error');return;}this.state='BOOT_PAIRS';const rawPairs=this.getBootPairs();const pairs=rawPairs.map((p,idx)=>{let bodyType=parseInt(p[1].substr(8,2),16);let ack=(bodyType<0x1B)?bodyType+1:bodyType-0x18;return {header:ProtocolUtils.hex(p[0]),body:ProtocolUtils.hex(p[1]),headerStr:p[0],bodyStr:p[1],type:bodyType,ackSeq:ack,id:idx+1};});this.logger(`Sending ${pairs.length}Boot Packet Pairs...`,'info');let p4=pairs.find(p=>p.id===4);if(p4){let b=p4.bodyStr;console.log(`[DEBUG PAIR 4]Length:${b.length}`);console.log(`[DEBUG PAIR 4]Start:${b.substring(0,20)}`);console.log(`[DEBUG PAIR 4]End:${b.substring(b.length-20)}`);}await this.sleep(200);for(let p=0;p<pairs.length;p++){let pair=pairs[p];this.subState=p;this.expectedBootSeq=pair.ackSeq;this.logger(`Sending Pair ${pair.id}:Type ${pair.type.toString(16).toUpperCase()}->Want ACK ${pair.ackSeq.toString(16).toUpperCase()}`,'info');let pairSuccess=false;let pairRetries=0;while(!pairSuccess&&pairRetries<5){pairRetries++;if(pairRetries>1)this.logger(`Retrying Pair ${pair.id}...`,'warn');this.packetAcked=false;this.lastMismatchAck=null;let headCheck=ProtocolUtils.validatePacketCRC(pair.headerStr);if(!headCheck.valid){this.logger(`[INTERNAL WARNING]Pair ${pair.id}Header CRC BAD!Expected:${headCheck.given.toString(16).toUpperCase().padStart(4,'0')}Calc:${headCheck.calc.toString(16).toUpperCase().padStart(4,'0')}`,'error');}let bodyCheck=ProtocolUtils.validatePacketCRC(pair.bodyStr);if(!bodyCheck.valid){this.logger(`[INTERNAL WARNING]Pair ${pair.id}Body CRC BAD!Expected:${bodyCheck.given.toString(16).toUpperCase().padStart(4,'0')}Calc:${bodyCheck.calc.toString(16).toUpperCase().padStart(4,'0')}`,'error');}else{}await this.serial.write(pair.header);await this.serial.write(pair.body);let totalLen=pair.header.length+pair.body.length;await this.simulateBaudWait(totalLen);let ackWait=0;while(!this.packetAcked&&ackWait<300){await this.sleep(10);ackWait++;}if(this.packetAcked)pairSuccess=true;if(!pairSuccess&&p===5&&this.lastMismatchAck===0x05){this.logger("Device requesting Pair 5(ACK 05). Rolling back sequence...",'warn');p-=2;pairSuccess=true;await this.sleep(100);break;}}if(!pairSuccess){this.logger(`Pair ${pair.id}Failed Max Retries. Aborting.`,'error');return;}if(p!==5||(p===5&&this.lastMismatchAck!==0x05)){this.logger(`Pair ${pair.id}OK.`,'success');}await this.sleep(330);}this.logger("Boot Complete. Starting Handover...",'info');this.state='HANDOVER';this.onStatus('Handover...');if(this.receivedHandover){this.logger("Handover Signal(1F)already captured.",'success');}else{let hoWait=0;while(!this.receivedHandover&&hoWait<200){await this.sleep(10);hoWait++;}}if(this.receivedHandover){this.logger("Handover Signal(1F)Received.",'success');}else{this.logger("Handover Timeout(Wait 1F). Proceeding anyway...",'warn');}this.logger("Waiting 1s for Device Flash Write...",'info');await this.sleep(1000);this.logger("Sending Run Command(07+08)...",'info');this.onStatus('Starting Dump...');await this.serial.write(ProtocolUtils.hex(this.FINAL_PKT_7));await this.sleep(20);await this.serial.write(ProtocolUtils.hex(this.FINAL_PKT_8));this.logger("Handover Done. Waiting for Dump Trigger...",'info');this.state='DUMP_READY';this.sendLinearDumpTrigger();}async sendLinearDumpTrigger(){this.logger("Starting Dump Trigger Loop(sending 0x10 polls)...",'info');for(let i=0;i<20;i++){if(this.state==='DUMPING'){this.logger("Dump Trigger:Transitioned to DUMPING.",'success');break;}await this.serial.write(ProtocolUtils.hex('1610020110101003005c'));await this.sleep(50);}if(this.state!=='DUMPING'){this.logger("Dump Trigger Loop Finished. Sending BootReq force...",'warn');await this.serial.write(ProtocolUtils.hex('161002010010030190'));}}stop(){this.state='IDLE';if(this.timer)clearTimeout(this.timer);}async handleFrame(frame){if(this.state==='IDLE')return;if(this.state==='BOOT_POLL'){if(frame.data[0]===0x10)this.packetAcked=true;return;}if(this.state==='BOOT_REQ'){let dataStr="";try{dataStr=new TextDecoder().decode(frame.data);}catch(e){}if(frame.data[0]===0x19||dataStr.includes("BOOT")||frame.data.length>5){this.link.sendFrame(frame.header,new Uint8Array([0x00]));this.packetAcked=true;}return;}if(this.state==='BOOT_PAIRS'){let rx=frame.data[0];this.logger(`[RX]${ProtocolUtils.hexArr(frame.data)}(Expect:${this.expectedBootSeq.toString(16).toUpperCase()})`,'info');if(frame.data.includes(0x1F)){this.receivedHandover=true;}if(rx===this.expectedBootSeq){this.packetAcked=true;}else if(this.expectedBootSeq===0x1F&&(rx===0x1E)){this.packetAcked=true;}else{if(rx<this.expectedBootSeq&&rx>0){this.logger(`Ignored old ACK:${rx.toString(16).toUpperCase()}`,'warn');}else{this.logger(`Mismatch!Got ${rx.toString(16).toUpperCase()}but wanted ${this.expectedBootSeq.toString(16).toUpperCase()}`,'warn');this.lastMismatchAck=rx;}}return;}if(this.state==='HANDOVER'){if(frame.data.includes(0x1F))this.receivedHandover=true;return;}if(this.state==='DUMP_READY'){this.logger(`[DUMP_READY RX]${ProtocolUtils.hexArr(frame.data)}`,'info');if(frame.data[0]===0x10){this.logger("DUMP_READY:Handshake(10)Received. Starting Dump...",'success');this.state='DUMPING';this.onStatus('Reading Data Pack...');this.subState=0;this.resetDumpTimeout();this.serial.write(ProtocolUtils.hex('161002010010030190'));}return;}if(this.state==='DUMPING'){this.resetDumpTimeout();await this.handleDumpFrame(frame);}}async handleDumpFrame(frame){if(!this.dumpState){this.dumpState='WAITING_PACK';this.transferPhase='HEADER';}let type=frame.data[0];try{this.rxLog.push({time:new Date().toISOString(),type:type.toString(16).toUpperCase().padStart(2,'0'),len:frame.data.length,data:Array.from (frame.data).map(b=>b.toString(16).toUpperCase().padStart(2,'0')).join(' ')});}catch(e){console.error("Log Error",e);}if(type===0x08){this.finish();return;}if(type>0x1F){this.logger(`[DUMP RX]Ignored High Type ${type.toString(16)}`,'warn');return;}let seq;let content;if(true){seq=type&0x07;if(frame.data.length===257){this.largeBlockHasArtifact=false;content=frame.data.slice(1);}else if(frame.data.length>257){this.largeBlockHasArtifact=true;this.logger(`[DUMP RX]Type ${type.toString(16)}:Non-Standard Length(${frame.data.length}). Artifact Detected. Slice(2).`,'warn');content=frame.data.slice(2);}else{content=frame.data.slice(1);}if(seq===4&&content.length>2&&this.transferPhase==='HEADER'){let sizeByte=content[1];this.physicalSize=sizeByte*8192;this.logger(`[DUMP INFO]Physical Pack Size:${this.physicalSize/1024}KB(Raw:${this.physicalSize})`,'info');}}if(this.dumpState==='WAITING_ECHO_ACK'){this.logger(`[DUMP FSM]Received Type ${type.toString(16)}while WAITING_ECHO_ACK. assuming Implicit ACK.`,'info');this.dumpState='WAITING_PACK';}if(type<0x18&&type!==0x08&&type!==0x1A){this.logger(`[DUMP]Received Control/ACK(Type ${type.toString(16)}). No Reply Needed.`,'info');return;}let shouldStore=false;if((type&0x07)===4&&this.transferPhase==='HEADER'){this.transferPhase='BODY';this.logger(`[DUMP RX]Phase Transition:HEADER->BODY(Type 1C Detected).`,'success');}if(this.transferPhase==='BODY'){if((type===0x19||type===0x1A)&&frame.data.length<10){this.logger(`[DUMP RX]Skipping Body Keep-Alive/Handshake(Type ${type.toString(16)}Len ${frame.data.length})`,'info');shouldStore=false;}else{shouldStore=true;}}else{if((type&0x07)===3&&content.length>=3){this.logicalSize=(content[0]<<16)|(content[1]<<8)|content[2];this.logger(`[DUMP INFO]Logical Data Size:${this.logicalSize}bytes`,'info');this.updateUI();}shouldStore=false;}if(shouldStore){for(let b of content)this.receivedData.push(b);this.logger(`[DUMP RX]Type:${type.toString(16).toUpperCase()}Seq:${seq}Bytes:${content.length}Total:${this.receivedData.length}`,'info');this.updateUI();}else{this.logger(`[DUMP RX]Skipped Logic Phase:${this.transferPhase}(Type ${type.toString(16).toUpperCase()})`,'info');}if(type===0x1A&&frame.data.length<10){this.logger(`[DUMP TX]Replaying Trace for Type 1A...`,'info');const start=performance.now();while(performance.now()-start<11);let ackFrame=ProtocolUtils.createFrame(frame.header,new Uint8Array([0x02]),0x01);this.logger(`[DIAGNOSTIC 1A]RX Data:${ProtocolUtils.hexArr(frame.data)}`,'warn');let echoFrame=ProtocolUtils.createFrame(frame.header,new Uint8Array([0x1A,0x02,0x4F]),0x01);let atomicPayload=new Uint8Array(ackFrame.length+echoFrame.length);atomicPayload.set(ackFrame,0);atomicPayload.set(echoFrame,ackFrame.length);this.logger(`[DIAGNOSTIC 1A]TX Data:${ProtocolUtils.hexArr(atomicPayload)}`,'warn');this.logger(`[DUMP TX]ATOMIC BURST:Sending ACK+Echo(${atomicPayload.length}bytes)`,'info');await this.serial.write(atomicPayload);this.dumpState='WAITING_ECHO_ACK';}else{await this.link.sendFrame(frame.header,new Uint8Array([seq]),undefined,0x01);let shouldFullEcho=false;if(type===0x19){if(frame.data.length<10)shouldFullEcho=true;else shouldFullEcho=false;}else{shouldFullEcho=false;}let echo;if(shouldFullEcho){this.logger(`[DUMP TX]Echoing Full Type 19(Keep-Alive)`,'info');echo=frame.data;}else{if(type===0x19){echo=new Uint8Array([type,0x01]);}else{echo=new Uint8Array([type,0x00]);}}await this.link.sendFrame(frame.header,echo,undefined,0x01);}this.dumpState='WAITING_ECHO_ACK';}updateUI(){const el=document.getElementById('byte-counter');if(el)el.innerText=this.receivedData.length;if(this.lastLoggedProgress===undefined)this.lastLoggedProgress=0;if(this.receivedData.length>=this.lastLoggedProgress+1024){this.logger(`[PROGRESS]Downloaded ${this.receivedData.length}bytes...`,'info');this.lastLoggedProgress=this.receivedData.length;}const elLogic=document.getElementById('logical-size');if(elLogic&&this.logicalSize)elLogic.innerText=this.logicalSize;const elPhys=document.getElementById('physical-size');const elPercent=document.getElementById('percent-used');if(elPhys&&this.physicalSize){elPhys.innerText=Math.round(this.physicalSize/1024);}if(elPercent&&this.logicalSize>0&&this.physicalSize>0){const used=(this.logicalSize/this.physicalSize)*100;elPercent.innerText=used.toFixed(1);}const elProgress=document.getElementById('progress-bar');const elContainer=document.getElementById('progress-container');const elText=document.getElementById('progress-text');if(elProgress&&elContainer){let percent=0;if(this.logicalSize>0){percent=(this.receivedData.length/this.logicalSize)*100;}else if(this.physicalSize>0){percent=(this.receivedData.length/this.physicalSize)*100;}if(percent>100)percent=100;if(this.receivedData.length>0){elContainer.style.display='block';elProgress.style.width=`${percent.toFixed(1)}%`;if(elText)elText.innerText=`${percent.toFixed(0)}%`;}else{}}}async finish(){if(this.finished)return;this.finished=true;this.onStatus('Transfer Complete');if(this.dumpTimeout)clearTimeout(this.dumpTimeout);this.updateUI();this.logger("Complete.",'success');this.logger('[TERMINATION]Sending End Signal(Type 07+08)...','info');try{await this.serial.write(ProtocolUtils.hex(this.FINAL_PKT_7));await this.sleep(20);await this.serial.write(ProtocolUtils.hex(this.FINAL_PKT_8));this.logger('[TERMINATION]End signal sent.','success');}catch(e){this.logger(`[TERMINATION]Warning:${e.message}`,'warn');}this.stop();this.receivedData.push(0xFF,0xFF);this.logger(`[OPK EXPORT]Appended 0xFF 0xFF terminator bytes.`,'info');const header=new Uint8Array(6);header.set([79,80,75],0);let len=this.receivedData.length;header[3]=(len>>16)&0xFF;header[4]=(len>>8)&0xFF;header[5]=len&0xFF;this.logger(`[OPK EXPORT]Header Added. Length:${len}(0x${len.toString(16).toUpperCase()})`,'info');const opkData=new Uint8Array(header.length+this.receivedData.length);opkData.set(header,0);opkData.set(new Uint8Array(this.receivedData),header.length);const sum=ProtocolUtils.calculateSimpleSum(opkData);const crc32=ProtocolUtils.calculateCRC32(opkData);this.logger(`[OPK CHECKS]Sum:0x${sum.toString(16).toUpperCase()}CRC32:0x${crc32.toString(16).toUpperCase()}`,'info');this.logger('[DISCONNECT]Stopping serial read loop for clean disconnect...','info');if(this.serial&&typeof this.serial.disconnect==='function'){this.serial.disconnect(false).then(()=>{this.logger('[DISCONNECT]Serial port released.','success');}).catch(e=>{this.logger(`[DISCONNECT]Warning:${e.message}`,'warn');});}if(this.onComplete)this.onComplete(true,{sum,crc32},opkData);}resetDumpTimeout(){if(this.dumpTimeout)clearTimeout(this.dumpTimeout);this.dumpTimeout=setTimeout(()=>{this.logger("Dump Silence Timeout(450ms). Assuming Complete.",'warn');this.finish();},450);}downloadRxLog(){if(!this.rxLog||this.rxLog.length===0){alert("No Log Data Available");return;}let txt="Time,Type,Length,Data\n";this.rxLog.forEach(row=>{txt+=`${row.time},${row.type},${row.len},"${row.data}"\n`;});const blob=new Blob([txt],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`RX_LOG_${new Date().getTime()}.csv`;a.click();}}