class LinkLayer{constructor(serial,logger){this.serial=serial;this.logger=logger||console.log;this.buffer=[];this.onFrame=null;this.serial.readLoop((data)=>this.processData(data));}flush(){this.buffer=[];this.logger('Link Buffer Flushed.','info');}processData(uint8Array){console.log(`[RAW RX] ${Array.from(uint8Array).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);for(let i=0;i<uint8Array.length;i++){this.buffer.push(uint8Array[i]);}if(this.buffer.length>4096){this.logger('Buffer Full (Clearing)','error');this.buffer=[];}this.parseBuffer();}calculateCRC(buffer){let crc=0x0000;const poly=0xA001;for(let i=0;i<buffer.length;i++){crc^=buffer[i];for(let j=0;j<8;j++){if(crc&1)crc=(crc>>>1)^poly;else crc=crc>>>1;}}return crc;}parseBuffer(){let ptr=0;const len=this.buffer.length;while(ptr<len){if(this.buffer[ptr]!==0x10){ptr++;continue;}if(ptr+2>=len)break;let payloadLen=this.buffer[ptr+2];if(ptr+6>len)break;let dataIdx=ptr+3;let current=dataIdx;let foundEnd=false;let crcData=[payloadLen];let extractedData=[];let frameValid=true;while(current<len){if(current-ptr>512){frameValid=false;foundEnd=false;break;}let b=this.buffer[current++];if(b===0x10){if(current>=len){frameValid=false;break;}let next=this.buffer[current++];if(next===0x10){crcData.push(0x10);extractedData.push(0x10);}else if(next===0x03){if(current+2>len){frameValid=false;break;}let csMsb=this.buffer[current++];let csLsb=this.buffer[current++];let rxCrc=(csMsb<<8)|csLsb;let calc=this.calculateCRC(crcData);let calcSwapped=((calc&0xFF)<<8)|((calc>>8)&0xFF);if(this.onFrame){this.onFrame({header:this.buffer[ptr+1],data:new Uint8Array(extractedData),valid:(calcSwapped===rxCrc)});if(calcSwapped!==rxCrc){this.logger(`[RX CRC FAIL] Given: ${rxCrc.toString(16).toUpperCase()} Calc: ${calcSwapped.toString(16).toUpperCase()}`,'error');}else{}}foundEnd=true;ptr=current;break;}else{crcData.push(next);extractedData.push(next);}}else{crcData.push(b);extractedData.push(b);}}if(foundEnd){continue;}else if(!frameValid){if(current-ptr>512){ptr++;continue;}break;}else{break;}}if(ptr>0){this.buffer=this.buffer.slice(ptr);}}async sendFrame(header,data,initOverride,lengthOverride){let len=(lengthOverride!==undefined)?lengthOverride:data.length;let packet=[0x16,0x10,header,len];let crcLoad=[len];let stuffedData=[];for(let b of data){crcLoad.push(b);if(b===0x10)stuffedData.push(0x10,0x10);else stuffedData.push(b);}let crc=this.calculateCRC(crcLoad);let frame=new Uint8Array([...packet,...stuffedData,0x10,0x03,crc&0xFF,(crc>>8)&0xFF]);console.log(`[RAW TX] ${Array.from(frame).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);await this.serial.write(frame);}}