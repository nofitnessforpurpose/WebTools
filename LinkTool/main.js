document.addEventListener('DOMContentLoaded',()=>{const connectBtn=document.getElementById('connectBtn');const disconnectBtn=document.getElementById('disconnectBtn');const packSelectBtn=document.getElementById('packSelectBtn');const rwSelectBtn=document.getElementById('rwSelectBtn');const saveBtn=document.getElementById('saveBtn');const downloadLogBtn=document.getElementById('downloadLogBtn');const statusDiv=document.getElementById('status');const logOutput=document.getElementById('logOutput');if(downloadLogBtn){downloadLogBtn.addEventListener('click',()=>{if(protocol)protocol.downloadRxLog();});}function isGreenType(type){return ['success','tx'].includes(type);}function isRedType(type){return ['error'].includes(type);}const urlParams=new URLSearchParams(window.location.search);const isDebug=urlParams.get('debug')==='true';let serialHandler=null;let protocol=null;let currentOpkData=null;let selectedPack='B';if(packSelectBtn){packSelectBtn.disabled=false;packSelectBtn.innerHTML='<i class="fa-solid fa-repeat"></i> Pack B';packSelectBtn.addEventListener('click',()=>{if(selectedPack==='B'){selectedPack='C';packSelectBtn.innerHTML='<i class="fa-solid fa-repeat"></i> Pack C';log('Pack C Selected (Pairs 3,4,5,6 Custom)','info');}else{selectedPack='B';packSelectBtn.innerHTML='<i class="fa-solid fa-repeat"></i> Pack B';log('Pack B Selected (Default)','info');}});}let logElements={};function log(message,type='info',id=null){if(!isDebug&&!isGreenType(type)&&!isRedType(type)){return;}if(isDebug&&type==='debug')return;if(!isDebug){if(!['success','tx','error'].includes(type))return;}while(logOutput.children.length>500){logOutput.removeChild(logOutput.firstChild);}if(id&&logElements[id]){logElements[id].textContent=`[${new Date().toLocaleTimeString()}] ${message}`;logElements[id].className=`log-entry log-${type}`;return;}const div=document.createElement('div');div.className=`log-entry log-${type}`;div.textContent=`[${new Date().toLocaleTimeString()}] ${message}`;logOutput.appendChild(div);logOutput.scrollTop=logOutput.scrollHeight;if(id)logElements[id]=div;}if(connectBtn){connectBtn.addEventListener('click',async ()=>{try{logOutput.innerHTML='';logElements={};currentOpkData=null;const elLogic=document.getElementById('logical-size');const elPhys=document.getElementById('physical-size');const elPercent=document.getElementById('percent-used');const elRx=document.getElementById('byte-counter');const pBar=document.getElementById('progress-bar');const pText=document.getElementById('progress-text');if(elLogic)elLogic.innerText='--';if(elPhys)elPhys.innerText='--';if(elPercent)elPercent.innerText='--';if(elRx)elRx.innerText='0';if(pBar)pBar.style.width='0%';if(pText)pText.innerText='0%';if(saveBtn)saveBtn.disabled=true;if(!serialHandler){serialHandler=new SerialHandler();}connectBtn.disabled=true;if(packSelectBtn)packSelectBtn.disabled=true;if(rwSelectBtn)rwSelectBtn.disabled=true;statusDiv.textContent='Status: Selecting Port...';await serialHandler.connect();statusDiv.textContent='Status: Connected';connectBtn.disabled=true;if(disconnectBtn)disconnectBtn.disabled=false;log('Port Opened. Starting Protocol...','success');protocol=new ProtocolHandler(serialHandler,log,(success,stats,opkData)=>{if(success){let msg='Status: Transfer Complete';if(stats){msg+=` | Sum: 0x${stats.sum.toString(16).toUpperCase()} | CRC: 0x${stats.crc32.toString(16).toUpperCase()}`;}statusDiv.textContent=msg;if(opkData){currentOpkData=opkData;if(saveBtn)saveBtn.disabled=false;log('Pack downloaded. Press "Save Pack" to save to file.','success');}connectBtn.disabled=false;connectBtn.textContent='Connect';log('Finished successfully.','success');if(disconnectBtn){disconnectBtn.classList.add('success-state');}}else{statusDiv.textContent='Status: Stopped/Failed';connectBtn.disabled=false;connectBtn.textContent='Connect';}if(downloadLogBtn){if(isDebug)downloadLogBtn.disabled=false;else downloadLogBtn.disabled=true;}},(status)=>{statusDiv.textContent=`Status: ${status}`;},selectedPack);await protocol.start();}catch(e){log(`Connection Failed: ${e.message}`,'error');statusDiv.textContent='Status: Error';connectBtn.disabled=false;if(packSelectBtn)packSelectBtn.disabled=false;if(rwSelectBtn)rwSelectBtn.disabled=false;if(disconnectBtn)disconnectBtn.disabled=true;if(saveBtn)saveBtn.disabled=true;}});}if(saveBtn){saveBtn.addEventListener('click',()=>{if(!currentOpkData){log('No data to save.','warn');return;}const now=new Date();const y=now.getFullYear();const m=String(now.getMonth()+1).padStart(2,'0');const d=String(now.getDate()).padStart(2,'0');const h=String(now.getHours()).padStart(2,'0');const min=String(now.getMinutes()).padStart(2,'0');const s=String(now.getSeconds()).padStart(2,'0');const rand=Array(8).fill(0).map(()=>String.fromCharCode(97+Math.floor(Math.random()*26))).join('');const filename=`${y}-${m}-${d} ${h}-${min}-${s} ${rand}.OPK`;if('showSaveFilePicker' in window){(async ()=>{try{const handle=await window.showSaveFilePicker({suggestedName:filename,types:[{description:'Psion Organiser Pack',accept:{'application/octet-stream':['.OPK']},}],});const writable=await handle.createWritable();await writable.write(currentOpkData);await writable.close();log(`Saved to: ${handle.name}`,'success');}catch(err){if(err.name!=='AbortError'){log(`Save Failed: ${err.message}`,'error');}}})();}else{const blob=new Blob([currentOpkData],{type:"application/octet-stream"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();log(`Saved (Download): ${filename}`,'success');}});}if(disconnectBtn){disconnectBtn.addEventListener('click',async ()=>{log('Disconnecting...','info');disconnectBtn.disabled=true;if(protocol){protocol.stop();protocol=null;}if(serialHandler){try{const disc=serialHandler.disconnect(true);const timeout=new Promise(r=>setTimeout(r,2000));await Promise.race([disc,timeout]);serialHandler=null;}catch(e){console.error(e);}}statusDiv.textContent='Status: Disconnected';connectBtn.disabled=false;connectBtn.textContent='Connect';if(packSelectBtn)packSelectBtn.disabled=false;if(rwSelectBtn)rwSelectBtn.disabled=false;if(saveBtn)saveBtn.disabled=true;if(downloadLogBtn)downloadLogBtn.disabled=true;currentOpkData=null;const progressBar=document.getElementById('progress-bar');const progressContainer=document.getElementById('progress-container');if(progressBar)progressBar.style.width='0%';if(progressBar)progressBar.innerText='0%';const elLogic=document.getElementById('logical-size');const elPhys=document.getElementById('physical-size');const elRx=document.getElementById('byte-counter');if(elLogic)elLogic.innerText='--';if(elPhys)elPhys.innerText='--';if(elRx)elRx.innerText='0';log('Disconnected.','success');});}if(navigator.serial){navigator.serial.addEventListener('disconnect',()=>{if(protocol)protocol.stop();statusDiv.textContent='Status: Device Unplugged';if(connectBtn){connectBtn.disabled=false;connectBtn.textContent='Connect';}if(disconnectBtn)disconnectBtn.disabled=true;if(packSelectBtn)packSelectBtn.disabled=false;if(rwSelectBtn)rwSelectBtn.disabled=false;log('Device unplugged.','warn');});}});